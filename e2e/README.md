# End-to-End Tests

This directory contains end-to-end (e2e) tests for the osrs-web-scraper CLI application. These tests run the actual CLI commands and validate the output against snapshot tests.

## Running E2E Tests

### Run all e2e tests

```bash
npm run test:e2e
```

### Update snapshots

When the CLI output changes intentionally, update the snapshots:

```bash
npm run test:e2e:update
```

### Run specific test files

```bash
npm run test:e2e -- cli.e2e.ts
```

### Running with Chrome/Chromium (for full scraping tests)

To run the full scraping tests, first install Chrome:

```bash
# Install Chrome for Puppeteer
npx puppeteer browsers install chrome

# Or install Chromium system-wide (Ubuntu/Debian)
sudo apt-get install chromium-browser

# Then run the tests
npm run test:e2e
```

**Note**: When Chrome/Chromium is available, the scraping tests will run and generate snapshot files in `e2e/__snapshots__/`.

## Test Structure

### CLI Tests (`cli.e2e.ts`)

Tests the CLI functionality including:

- **Help text display**: Validates CLI help output and command structure
- **Version information**: Tests version display
- **News scraping**: Tests news post scraping with the specified URL
- **Poll scraping**: Tests poll scraping with the specified URL
- **Worlds scraping**: Tests the worlds list scraping
- **Parameter validation**: Ensures commands require proper arguments
- **Error handling**: Validates error messages and exit codes

Each scraping test validates:

1. Command exits successfully (exit code 0)
2. Expected output files are created in `./out/<command>/`
3. Generated MediaWiki content matches snapshot tests

## Snapshot Tests

The e2e tests use Jest snapshot testing to ensure output consistency. Snapshots are stored in `e2e/__snapshots__/` and capture the exact MediaWiki content generated by the CLI.

### When to Update Snapshots

Update snapshots when:

- You intentionally change the MediaWiki output format
- You add new features that change the generated content
- You fix bugs that affect the output

**Never update snapshots without reviewing the changes first!**

## Browser Requirements

The scraping tests require Chrome/Chromium to be installed for Puppeteer:

- Install Chrome: `npx puppeteer browsers install chrome`
- Alternative: `sudo apt-get install chromium-browser`

## Test URLs

The e2e tests use these specific URLs as requested in the issue:

- **News**: https://secure.runescape.com/m=news/a=13/sailing---resources--skilling-activities-poll?oldschool=1
- **Poll**: https://secure.runescape.com/m=poll/a=13/oldschool/results?id=1708

## File Structure

```
e2e/
├── __snapshots__/          # Jest snapshots
│   └── cli.e2e.ts.snap    # Snapshot file for CLI tests
├── utils/                  # Test utilities
│   └── cli.ts             # CLI testing utilities
├── cli.e2e.ts             # Main CLI functionality tests
├── jest.config.js         # Jest configuration for e2e tests
└── README.md              # This file
```

## Example Test Output

When tests run successfully, they validate:

1. **CLI Help Output**:

   ```
   Usage: OSRS Web Scraper [options] [command]
   Commands:
     news [string]   Scrape an OSRS news posts.
     poll <string>   Scrape an OSRS poll.
     worlds          Scrape the OSRS world list.
   ```

2. **File Creation**:

   - `./out/news/Sailing - Resources & Skilling Activities Poll.txt`
   - `./out/poll/Poll 1708.txt`

3. **MediaWiki Content**:

   ```
   {{Update
   |url = https://...
   |date = ...
   |category = ...
   }}
   ```

4. **Snapshot Matching**: Content matches the stored snapshot exactly

## Adding New Tests

To add new e2e tests:

1. Add test cases to `cli.e2e.ts` or create new test files
2. Use the utilities in `utils/cli.ts` for running commands
3. Follow the existing patterns for file validation and snapshot testing
4. Run tests with `-u` flag to generate initial snapshots
5. Review and commit the snapshots

Example:

```typescript
it("should scrape new content type", async () => {
  const result = await runCLICommand({
    command: "npm run start",
    args: ["--", "news", "https://example.com/news"],
    timeout: 180000,
  });

  expect(result.exitCode).toBe(0);
  expect(result.outputContent).toMatchSnapshot("new-content.txt");
});
```
